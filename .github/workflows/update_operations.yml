# This workflow creates a PR to update the workflow figures.

name: update_workflow_figures

on:
  schedule:
    # Run every 5 minutes past the hour
    - cron: "5 * * * *"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      ### Start of copy from run_edps_cached.yaml ###
      - name: Install dependencies with cache
        id: cache-dep
        uses: awalsh128/cache-apt-pkgs-action@latest
        env:
          cache-name: cache-dependencies
        with:
          packages: wget gcc  automake autogen libtool gsl-bin libgsl-dev libfftw3-bin libfftw3-dev fftw-dev
            curl bzip2 less subversion git cppcheck lcov valgrind
            zlib1g zlib1g-dev
            liberfa1 liberfa-dev
            libcurl4-openssl-dev libcurl4
            tmux ripgrep file
            libcfitsio-bin libcfitsio-dev
            wcslib-dev wcslib-tools
            libcpl-dev
            libblas3
            perl cmake
            graphviz meld
            emacs vim nano
          version: 1.0
          # execute_install_scripts: true

      - name: Setup edps cache
        id: cache-pip
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'
          cache: 'pip' # caching pip dependencies

      - name: Install edps with cache
        run: |
          export PYCPL_RECIPE_DIR="$(pwd)/metisp/pyrecipes/"
          pip install -r ./toolbox/requirements.txt

      - name: Setup edps config
        run: ./toolbox/create_config.sh
      ### End of copy from run_edps_cached.yaml ###

      - name: Create figures
        run: |
          # https://askubuntu.com/questions/503567/dot-doesnt-recognize-any-formats
          sudo dot -c
          bash toolbox/make_edps_graphs.sh

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Update workflow figures"
          branch: update-operations-wiki-export
          delete-branch: true
          title: "[Assist PR] Update workflow figures"
          body: |
            Update workflow figures.
            Auto-generated.
          labels: |
            automated
          draft: false
