name: Run EDPS workflows automatically or manually

on:
  workflow_dispatch:  # Manual trigger
  #schedule:
  #  - cron: '0 1 * * *'  # Run on 0:00 UTC 

jobs:
  run:
    runs-on: [self-hosted, Linux, pipeline, zeus]
    steps:
      - uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          # python3 -m venv metispipe
          # . metispipe/bin/activate
          export PYCPL_RECIPE_DIR="$(pwd)/metisp/pyrecipes/"
          ./toolbox/create_config.sh
      - name: Find latest data directory
        id: find_data
        run: |
          if [ -L "/data/LatestBuild" ]; then
            DATA_DIR="/data/LatestBuild/imgLM"
            echo "Using symlink: $DATA_DIR"
          elif [ -d "/data/LatestBuild/imgLM" ]; then
            DATA_DIR="/data/LatestBuild/imgLM"
            echo "Using direct path: $DATA_DIR"
          else
            LATEST_DIR=$(ls -d /data/20??-??-??/imgLM 2>/dev/null | sort -r | head -n1)
            if [ -n "$LATEST_DIR" ]; then
              DATA_DIR="$LATEST_DIR"
              echo "Using latest dated directory: $DATA_DIR"
            else
              echo "No data directory found!"
              ls -la /data/ || echo "/data does not exist"
              exit 1
            fi
          fi
          
          echo "data_dir=$DATA_DIR" >> $GITHUB_OUTPUT
          ls -la "$DATA_DIR"

      - name: Setting up environment
        run: |
          ./toolbox/create_config.sh
          export PATH="$HOME/.local/bin:$PATH"
          # . metispipe/bin/activate
          export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/blas:/usr/lib/x86_64-linux-gnu/lapack:$LD_LIBRARY_PATH
          export PYESOREX_PLUGIN_DIR="$(pwd)/metisp/pyrecipes/"
          export PYCPL_RECIPE_DIR="$(pwd)/metisp/pyrecipes/"
          export PYTHONPATH="$(pwd)/metisp/pymetis/src/"
          export SOF_DATA="/data/LatestBuild/imgLM"

          # . metispipe/bin/activate
          edps --shutdown
          edps -lw
          edps -w metis.metis_wkf -i $SOF_DATA -c
          edps -w metis.metis_wkf -i $SOF_DATA -lt
          edps -w metis.metis_lm_img_wkf -i $SOF_DATA -m science | tee edps.stdout.txt
          # ! grep "'FAILED'" edps.stdout.txt
